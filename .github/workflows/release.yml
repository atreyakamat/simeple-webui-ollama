name: "OllaDesk Release"

on:
  push:
    tags:
      - "v*.*.*"   # triggers on semantic version tags like v1.0.1

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-tauri:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows â€” WebView2 is pre-installed on windows-latest runners
          - platform: windows-latest
            rust-target: x86_64-pc-windows-msvc
            args: ""

          # macOS Intel
          - platform: macos-latest
            rust-target: x86_64-apple-darwin
            args: "--target x86_64-apple-darwin"

          # Linux â€” Ubuntu 22.04 for broad distro compatibility
          - platform: ubuntu-22.04
            rust-target: x86_64-unknown-linux-gnu
            args: ""

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ Node â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Node 20 (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      # â”€â”€ Rust â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust-target }}

      # Cache Rust build artifacts â€” critical for Windows (otherwise ~20min compile)
      - name: Cache Rust build artifacts
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"
          cache-on-failure: true

      # â”€â”€ Linux system deps (Tauri v2 requires webkit2gtk-4.1, NOT 4.0) â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Linux system dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev

      # â”€â”€ Frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install frontend dependencies
        run: npm ci

      # â”€â”€ Build & Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build and publish Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Disable updater signing requirement (no signing key configured)
          TAURI_SIGNING_PRIVATE_KEY: ""
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""
        with:
          tagName: v__VERSION__
          releaseName: "OllaDesk v__VERSION__"
          releaseBody: |
            ## ðŸš€ OllaDesk v__VERSION__

            A local-first AI workspace powered by Ollama.

            ### ðŸ“¦ Downloads
            | Platform | File |
            |---|---|
            | Windows | `.msi` installer or `.exe` setup |
            | macOS | `.dmg` disk image |
            | Linux | `.AppImage` (portable) or `.deb` |

            ### ðŸ“‹ Requirements
            1. Install **Ollama** â†’ https://ollama.com/download
            2. Pull a model: `ollama pull llama3`
            3. Start Ollama (it runs in the background automatically)
            4. Launch OllaDesk

            > **Note**: OllaDesk connects to Ollama at `http://127.0.0.1:11434` â€” no internet required.

          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}